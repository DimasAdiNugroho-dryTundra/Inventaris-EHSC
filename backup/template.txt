<?php
require('../server/sessionHandler.php');
require('../server/configDB.php');
require('../layouts/header.php');

// Pengaturan untuk pagination
$limit = isset($_GET['limit']) ? (int) $_GET['limit'] : 5; // Default ke 5
$page = isset($_GET['page']) ? (int) $_GET['page'] : 1;
$offset = ($page - 1) * $limit;

// Penanganan pencarian
$search = isset($_POST['search']) ? $_POST['search'] : '';
$query = "SELECT * FROM user WHERE nama LIKE '%$search%' LIMIT $limit OFFSET $offset";
$result = mysqli_query($conn, $query);

// Hitung total data untuk pagination
$totalQuery = "SELECT COUNT(*) as total FROM user WHERE nama LIKE '%$search%'";
$totalResult = mysqli_query($conn, $totalQuery);
$totalRow = mysqli_fetch_assoc($totalResult);
$totalPages = ceil($totalRow['total'] / $limit);

// Proses penambahan user
if (isset($_POST['tambahUser'])) {
    $nama = $_POST['nama'];
    $username = $_POST['username'];
    $password = md5($_POST['password']);
    $email = $_POST['email'];
    $jabatan = $_POST['jabatan'];
    $hak_akses = $_POST['hak_akses'];

    $uploadDir = '../upload/user/';
    $foto = $_FILES['foto'];
    $fotoName = basename($foto['name']);
    $fotoTmp = $foto['tmp_name'];
    $fotoSize = $foto['size']; // Ambil ukuran foto
    $fotoPath = $uploadDir . $fotoName;

    // Check file size
    if ($fotoSize > 5242880) { // Ukuran lebih dari 5MB
        $error_message = "File size exceeds 5MB.";
    } else {
        // Move the uploaded file
        if (move_uploaded_file($fotoTmp, $fotoPath)) {
            $query = "INSERT INTO user (nama, username, password, email, jabatan, foto, hak_akses)
                      VALUES ('$nama', '$username', '$password', '$email', '$jabatan', '$fotoName', '$hak_akses')";
            if (mysqli_query($conn, $query)) {
                $_SESSION['error_message'] = "User berhasil ditambahkan!";
            } else {
                $_SESSION['error_message'] = "Gagal menambahkan user: " . mysqli_error($conn);
            }
        } else {
            $_SESSION['error_message'] = "Gagal mengupload foto.";
        }
    }
    header("Location: manajemen-user.php");
    exit(); // Tambahkan exit agar tidak melanjutkan eksekusi
}

// Proses pengeditan user
if (isset($_POST['action']) && $_POST['action'] == 'update') {
    $id_user = $_POST['id_user'];
    $username = $_POST['username'];
    $email = $_POST['email'];
    $jabatan = $_POST['jabatan'];
    $password = !empty($_POST['password']) ? md5($_POST['password']) : null;

    // Mulai query update
    $query = "UPDATE user SET username = '$username', email = '$email', jabatan = '$jabatan'";

    // Tambahkan password jika ada
    if ($password) {
        $query .= ", password = '$password'";
    }

    // Proses upload foto jika ada
    if (isset($_FILES['foto']) && $_FILES['foto']['error'] == UPLOAD_ERR_OK) {
        $uploadDir = '../upload/user/';
        $foto = $_FILES['foto'];
        $fotoName = basename($foto['name']);
        $fotoSize = $foto['size']; // Ambil ukuran foto
        $fotoTmp = $foto['tmp_name'];
        $fotoPath = $uploadDir . $fotoName;

        // Cek ukuran file
        if ($fotoSize > 5242880) { // Ukuran lebih dari 5MB
            $error_message = "File size exceeds 5MB.";
        } else {
            // Ambil nama foto lama dari database
            $queryOld = "SELECT foto FROM user WHERE id_user='$id_user'";
            $resultOld = mysqli_query($conn, $queryOld);

            if ($user = mysqli_fetch_assoc($resultOld)) {
                $oldFotoPath = $uploadDir . $user['foto'];

                // Hapus foto lama dari server jika ada
                if (file_exists($oldFotoPath)) {
                    unlink($oldFotoPath);
                }
            }

            // Pindahkan file foto baru
            if (move_uploaded_file($fotoTmp, $fotoPath)) {
                $query .= ", foto = '$fotoName'";
            } else {
                $error_message = "Gagal mengupload foto baru.";
            }
        }
    }

    // Akhiri query dengan kondisi WHERE
    $query .= " WHERE id_user = '$id_user'";
    if (!mysqli_query($conn, $query)) {
        $_SESSION['error_message'] = "Gagal mengubah user: " . mysqli_error($conn);
    } else {
        $_SESSION['error_message'] = "User berhasil diubah!";
    }

    header("Location: manajemen-user.php");
    exit(); // Tambahkan exit agar tidak melanjutkan eksekusi
}


// Proses penghapusan user
if (isset($_GET['delete'])) {
    $id_user = $_GET['delete'];

    // Ambil nama foto dari database
    $query = "SELECT foto FROM user WHERE id_user='$id_user'";
    $result = mysqli_query($conn, $query);
    $user = mysqli_fetch_assoc($result);

    // Hapus foto dari server
    if ($user && !empty($user['foto'])) {
        $fotoPath = '../upload/user/' . $user['foto'];
        if (file_exists($fotoPath)) {
            unlink($fotoPath); // Menghapus file foto
        }
    }

    // Hapus data user dari database
    $query = "DELETE FROM user WHERE id_user='$id_user'";
    if (mysqli_query($conn, $query)) {
        $_SESSION['error_message'] = "User berhasil dihapus!";
    } else {
        $_SESSION['error_message'] = "Gagal menghapus user: " . mysqli_error($conn);
    }

    header("Location: manajemen-user.php");
}

?>

<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <?php require('../layouts/sidePanel.php'); ?>

        <div class="layout-page">
            <!-- navbar -->

            <div class="content-wrapper">
                <div class="container-xxl flex-grow-1 container-p-y">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h2 class="mb-1">Manajemen User</h2>
                        </div>
                        <div class="mt-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb breadcrumb-style1">
                                    <li class="breadcrumb-item">
                                        <a href="dashboard.php">Dashboard</a>
                                    </li>
                                    <li class="breadcrumb-item active">Manajemen User</li>
                                </ol>
                            </nav>
                        </div>
                    </div>

                    <div class="card">
                        <?php if (isset($_SESSION['error_message'])): ?>
                        <div class="alert alert-solid-danger d-flex align-items-center" role="alert">
                            <span class="alert-icon rounded">
                                <i class="ti ti-ban"></i>
                            </span>
                            <?php echo $_SESSION['error_message']; ?>
                        </div>
                        <?php unset($_SESSION['error_message']); ?>
                        <!-- Hapus pesan setelah ditampilkan -->
                        <?php endif; ?>
                        <h4 class="card-header d-flex justify-content-between align-items-center">
                            Data User
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#tambahUserModal">Tambah User</button>
                        </h4>


                        <!-- Form Pencarian dan Pagination -->
                        <div class="row p-3">
                            <div class="col-md-6">
                                <form method="POST" class="d-flex">
                                    <input type="text" class="form-control me-2" name="search"
                                        placeholder="Cari nama user..." value="<?php echo $search; ?>">
                                    <button class="btn btn-outline-secondary" type="submit">Cari</button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <form class="d-flex justify-content-end align-items-center">
                                    <label for="limit" class="label me-2">Tampilkan:</label>
                                    <select id="limit" class="select2 form-select" onchange="location = this.value;">
                                        <option value="manajemen-user.php?limit=5"
                                            <?php if ($limit == 5) echo 'selected'; ?>>5</option>
                                        <option value="manajemen-user.php?limit=10"
                                            <?php if ($limit == 10) echo 'selected'; ?>>10</option>
                                        <option value="manajemen-user.php?limit=20"
                                            <?php if ($limit == 20) echo 'selected'; ?>>20</option>
                                    </select>
                                </form>
                            </div>
                        </div>

                        <div class="table-responsive text-nowrap" style="max-height: 340px;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>No</th>
                                        <th>Nama</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Jabatan</th>
                                        <th>Hak Akses</th>
                                        <th>Foto</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php
                                    $no = 1;
                                    while ($row = mysqli_fetch_assoc($result)) { ?>
                                    <tr>
                                        <td><?php echo $no++; ?></td>
                                        <td><?php echo $row['nama']; ?></td>
                                        <td><?php echo $row['username']; ?></td>
                                        <td><?php echo $row['email']; ?></td>
                                        <td><?php echo $row['jabatan']; ?></td>
                                        <td><?php echo $row['hak_akses']; ?></td>
                                        <td><img src="../upload/user/<?php echo $row['foto']; ?>" alt="User Photo"
                                                style="width: 50px; height: 50px;"></td>
                                        <td>
                                            <button class="btn btn-info btn-sm" data-bs-toggle="modal"
                                                data-bs-target="#modal-update-<?php echo $row['id_user']; ?>">Edit</button>
                                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                                data-bs-target="#modal-delete-<?php echo $row['id_user']; ?>">Delete</button>

                                        </td>
                                    </tr>
                                    <?php
                                        // Modal Update
                                    echo "
                                        <div class='modal fade' id='modal-update-" . $row['id_user'] . "' tabindex='-1' aria-labelledby='modalUpdateLabel' aria-hidden='true'>
                                            <div class='modal-dialog modal-lg modal-dialog-centered' role='document'>
                                                <div class='modal-content'>
                                                    <div class='modal-header'>
                                                        <h4 class='modal-title' id='modalUpdateLabel'>Edit User</h4>
                                                        <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
                                                    </div>
                                                    <div class='modal-body'>
                                                        <form method='post' action='manajemen-user.php' enctype='multipart/form-data'>
                                                            <input type='hidden' name='action' value='update'>
                                                            <input type='hidden' name='id_user' value='" . $row['id_user'] . "'>
                                                            <div class='mb-3'>
                                                                <label for='username' class='form-label'>Username</label>
                                                                <input type='text' class='form-control' name='username' value='" . $row['username'] . "' required>
                                                            </div>
                                                            <div class='mb-3'>
                                                                <label for='email' class='form-label'>Email</label>
                                                                <input type='email' class='form-control' name='email' value='" . $row['email'] . "' required>
                                                            </div>
                                                            <div class='mb-3'>
                                                                <label for='jabatan' class='form-label'>Jabatan</label>
                                                                <input type='text' class='form-control' name='jabatan' value='" . $row['jabatan'] . "' required>
                                                            </div>
                                                            <div class='mb-3'>
                                                                <label for='password' class='form-label'>Password</label>
                                                                <input type='password' class='form-control' name='password'>
                                                            </div>
                                                            <div class='mb-3'>
                                                                <label for='foto' class='form-label'>Foto (max 5MB, 1:1 aspect ratio)</label>
                                                                <input type='file' name='foto' class='form-control' accept='image/*'>
                                                            </div>
                                                            <button type='submit' class='btn btn-primary'>Simpan</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>";
                                    
                                    // modal validasi hapus
                                    echo"
                                        <div class='modal fade' id='modal-delete-" . $row['id_user'] . "' tabindex='-1'
                                            aria-labelledby='modalDeleteLabel' aria-hidden='true'>
                                            <div class='modal-dialog modal-dialog-centered' role='document'>
                                                <div class='modal-content'>
                                                    <div class='modal-header'>
                                                        <h5 class='modal-title' id='modalDeleteLabel'>Konfirmasi Hapus</h5>
                                                        <button type='button' class='btn-close' data-bs-dismiss='modal'
                                                            aria-label='Close'></button>
                                                    </div>
                                                    <div class='modal-body'>
                                                        Apakah Anda yakin ingin menghapus user " . $row['nama'] . "?
                                                    </div>
                                                    <div class='modal-footer'>
                                                        <button type='button' class='btn btn-secondary'
                                                            data-bs-dismiss='modal'>Batal</button>
                                                        <form method='get' action='manajemen-user.php'>
                                                            <input type='hidden' name='delete' value='" . $row['id_user'] . "'>
                                                            <button type='submit' class='btn btn-danger'>Hapus</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>";
                                    } ?>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <nav aria-label="Page navigation" class="mt-4">
                            <ul class="pagination pagination-rounded justify-content-center">
                                <?php if ($page > 1) { ?>
                                <li class="page-item">
                                    <a class="page-link" href="?page=<?php echo $page - 1; ?>" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <?php } ?>
                                <?php for ($i = 1; $i <= $totalPages; $i++) { ?>
                                <li class="page-item <?php if ($i == $page) echo 'active'; ?>">
                                    <a class="page-link" href="?page=<?php echo $i; ?>"><?php echo $i; ?></a>
                                </li>
                                <?php } ?>
                                <?php if ($page < $totalPages) { ?>
                                <li class="page-item">
                                    <a class="page-link" href="?page=<?php echo $page + 1; ?>" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <?php } ?>
                            </ul>
                        </nav>
                    </div>


                    <!-- Modal Tambah User -->
                    <div class="modal fade" id="tambahUserModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Tambah User</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form method="POST" action="manajemen-user.php" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <label class="form-label">Nama</label>
                                            <input type="text" name="nama" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Username</label>
                                            <input type="text" name="username" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Password</label>
                                            <input type="password" name="password" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Email</label>
                                            <input type="email" name="email" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Jabatan</label>
                                            <input type="text" name="jabatan" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Hak Akses</label>
                                            <input type="number" name="hak_akses" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Foto (max 5MB)</label>
                                            <input type="file" name="foto" class="form-control" accept="image/*"
                                                required>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" name="tambahUser"
                                                class="btn btn-primary">Tambah</button>
                                            <button type="button" class="btn btn-secondary"
                                                data-bs-dismiss="modal">Batal</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal validasi hapus -->
                    <div class="modal fade" id="modal-delete-<?php echo $row['id_user']; ?>" tabindex="-1"
                        aria-labelledby="modalDeleteLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalDeleteLabel">Konfirmasi Hapus</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Apakah Anda yakin ingin menghapus user <?php echo $row['nama']; ?>?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Batal</button>
                                    <form method="get" action="manajemen-user.php">
                                        <input type="hidden" name="delete" value="<?php echo $row['id_user']; ?>">
                                        <button type="submit" class="btn btn-danger">Hapus</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- Footer -->
            <?php
            require('../layouts/footer.php');
            ?>
            <!-- / Footer -->

            <div class="content-backdrop fade"></div>
        </div>
        <!-- Content wrapper -->
    </div>
    <!-- / Layout page -->
</div>

<!-- Overlay -->
<div class="layout-overlay layout-menu-toggle"></div>

<!-- Drag Target Area To SlideIn Menu On Small Screens -->
<div class="drag-target"></div>
</div>
<!-- / Layout wrapper -->

<?php
require('../layouts/assetsFooter.php')

    ?>

<?php
require('../server/sessionHandler.php');
require('../server/configDB.php');
require('../layouts/header.php');

// Pengaturan untuk pagination
$limit = isset($_GET['limit']) ? (int) $_GET['limit'] : 5;
$page = isset($_GET['page']) ? (int) $_GET['page'] : 1;
$offset = ($page - 1) * $limit;

// Penanganan pencarian
$search = isset($_POST['search']) ? $_POST['search'] : '';

// Query untuk menampilkan data penerimaan barang dengan join ke permintaan
$query = "SELECT pb.*, prb.*, d.nama_departemen 
          FROM penerimaan_barang prb
          JOIN permintaan_barang pb ON prb.id_permintaan = pb.id_permintaan
          JOIN departemen d ON pb.id_departemen = d.id_departemen
          WHERE pb.nama_barang LIKE '%$search%'
          LIMIT $limit OFFSET $offset";
$result = mysqli_query($conn, $query);

// Hitung total data untuk pagination
$totalQuery = "SELECT COUNT(*) as total FROM penerimaan_barang prb
               JOIN permintaan_barang pb ON prb.id_permintaan = pb.id_permintaan
               WHERE pb.nama_barang LIKE '%$search%'";
$totalResult = mysqli_query($conn, $totalQuery);
$totalRow = mysqli_fetch_assoc($totalResult);
$totalPages = ceil($totalRow['total'] / $limit);

// Proses penambahan penerimaan barang
if (isset($_POST['tambahPenerimaan'])) {
    $id_permintaan = $_POST['id_permintaan'];
    $tanggal_terima = $_POST['tanggal_terima'];
    $jumlah = $_POST['jumlah'];
    $satuan = $_POST['satuan'];
    $status = $_POST['status'];

    // Ambil nama barang dari permintaan
    $getBarangQuery = "SELECT nama_barang FROM permintaan_barang WHERE id_permintaan = '$id_permintaan'";
    $barangResult = mysqli_query($conn, $getBarangQuery);
    $barangData = mysqli_fetch_assoc($barangResult);
    $nama_barang = $barangData['nama_barang'];

    $query = "INSERT INTO penerimaan_barang (id_permintaan, nama_barang, tanggal_terima, jumlah, satuan, status)
              VALUES ('$id_permintaan', '$nama_barang', '$tanggal_terima', '$jumlah', '$satuan', '$status')";
    
    if (mysqli_query($conn, $query)) {
        $_SESSION['success_message'] = "Penerimaan barang berhasil ditambahkan!";
    } else {
        $_SESSION['error_message'] = "Gagal menambahkan penerimaan barang: " . mysqli_error($conn);
    }
    header("Location: penerimaanBarang.php");
    exit();
}

// Proses pengeditan penerimaan barang
if (isset($_POST['action']) && $_POST['action'] == 'update') {
    $id_penerimaan = $_POST['id_penerimaan'];
    $tanggal_terima = $_POST['tanggal_terima'];
    $jumlah = $_POST['jumlah'];
    $satuan = $_POST['satuan'];
    $status = $_POST['status'];

    $query = "UPDATE penerimaan_barang SET
              tanggal_terima = '$tanggal_terima',
              jumlah = '$jumlah',
              satuan = '$satuan',
              status = '$status'
              WHERE id_penerimaan = '$id_penerimaan'";

    if (mysqli_query($conn, $query)) {
        $_SESSION['success_message'] = "Penerimaan barang berhasil diubah!";
    } else {
        $_SESSION['error_message'] = "Gagal mengubah penerimaan barang: " . mysqli_error($conn);
    }
    header("Location: penerimaanBarang.php");
    exit();
}

// Proses penghapusan penerimaan barang
if (isset($_GET['delete'])) {
    $id_penerimaan = $_GET['delete'];
    $query = "DELETE FROM penerimaan_barang WHERE id_penerimaan='$id_penerimaan'";
    if (mysqli_query($conn, $query)) {
        $_SESSION['success_message'] = "Penerimaan barang berhasil dihapus!";
    } else {
        $_SESSION['error_message'] = "Gagal menghapus penerimaan barang: " . mysqli_error($conn);
    }
    header("Location: penerimaanBarang.php");
    exit();
}
?>

<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <?php require('../layouts/sidePanel.php'); ?>

        <div class="layout-page">
            <div class="content-wrapper">
                <div class="container-xxl flex-grow-1 container-p-y">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h2 class="mb-1">Manajemen Penerimaan Barang</h2>
                        </div>
                        <div class="mt-3">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb breadcrumb-style1">
                                    <li class="breadcrumb-item">
                                        <a href="dashboard.php">Dashboard</a>
                                    </li>
                                    <li class="breadcrumb-item active">Manajemen Penerimaan Barang</li>
                                </ol>
                            </nav>
                        </div>
                    </div>

                    <div class="card">
                        <?php if (isset($_SESSION['error_message'])): ?>
                        <div class="alert alert-danger alert-dismissible d-flex align-items-center" role="alert">
                            <span class="alert-icon rounded">
                                <i class="ti ti-ban"></i>
                            </span>
                            <?php echo $_SESSION['error_message']; ?>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <?php unset($_SESSION['error_message']); ?>
                        <?php endif; ?>

                        <?php if (isset($_SESSION['success_message'])): ?>
                        <div class="alert alert-success alert-dismissible d-flex align-items-center" role="alert">
                            <span class="alert-icon rounded">
                                <i class="ti ti-check"></i>
                            </span>
                            <?php echo $_SESSION['success_message']; ?>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <?php unset($_SESSION['success_message']); ?>
                        <?php endif; ?>

                        <h4 class="card-header d-flex justify-content-between align-items-center">
                            Data Penerimaan Barang
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#tambahPenerimaanModal">Tambah Penerimaan</button>
                        </h4>

                        <div class="row p-3">
                            <div class="col-md-6">
                                <form method="POST" class="d-flex">
                                    <input type="text" class="form-control me-2" name="search"
                                        placeholder="Cari nama barang..." value="<?php echo $search; ?>">
                                    <button class="btn btn-outline-secondary" type="submit">Cari</button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <form class="d-flex justify-content-end align-items-center">
                                    <label for="limit" class="label me-2">Tampilkan:</label>
                                    <select id="limit" class="select2 form-select" onchange="location = this.value;">
                                        <option value="permintaan_barang.php?limit=5"
                                            <?php if ($limit == 5) echo 'selected'; ?>>5</option>
                                        <option value="permintaan_barang.php?limit=10"
                                            <?php if ($limit == 10) echo 'selected'; ?>>10</option>
                                        <option value="permintaan_barang.php?limit=20"
                                            <?php if ($limit == 20) echo 'selected'; ?>>20</option>
                                    </select>
                                </form>
                            </div>
                        </div>

                        <div class="table-responsive text-nowrap">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>No</th>
                                        <th>Departemen</th>
                                        <th>Nama Barang</th>
                                        <th>Tanggal Terima</th>
                                        <th>Jumlah</th>
                                        <th>Satuan</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php
                                    $no = $offset + 1;
                                    while ($row = mysqli_fetch_assoc($result)) {
                                    ?>
                                    <tr>
                                        <td><?php echo $no++; ?></td>
                                        <td><?php echo $row['nama_departemen']; ?></td>
                                        <td><?php echo $row['nama_barang']; ?></td>
                                        <td><?php echo $row['tanggal_terima']; ?></td>
                                        <td><?php echo $row['jumlah']; ?></td>
                                        <td><?php echo $row['satuan']; ?></td>
                                        <td><?php echo $row['status']; ?></td>
                                        <td>
                                            <button class="btn btn-info btn-sm" data-bs-toggle="modal"
                                                data-bs-target="#modal-update-<?php echo $row['id_penerimaan']; ?>">Edit</button>
                                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                                data-bs-target="#modal-delete-<?php echo $row['id_penerimaan']; ?>">Delete</button>
                                            <a href="laporan_penerimaan.php?id=<?php echo $row['id_permintaan']; ?>"
                                                class="btn btn-primary btn-sm">Laporan</a>
                        </div>
                        </td>
                        </tr>

                        <!-- Modal Update -->
                        <div class="modal fade" id="modal-update-<?php echo $row['id_penerimaan']; ?>" tabindex="-1"
                            aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Edit Penerimaan Barang</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form method="POST">
                                            <input type="hidden" name="action" value="update">
                                            <input type="hidden" name="id_penerimaan"
                                                value="<?php echo $row['id_penerimaan']; ?>">
                                            <div class="mb-3">
                                                <label class="form-label">Tanggal Terima</label>
                                                <input type="date" name="tanggal_terima" class="form-control"
                                                    value="<?php echo $row['tanggal_terima']; ?>" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Jumlah</label>
                                                <input type="number" name="jumlah" class="form-control"
                                                    value="<?php echo $row['jumlah']; ?>" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Satuan</label>
                                                <input type="text" name="satuan" class="form-control"
                                                    value="<?php echo $row['satuan']; ?>" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Status</label>
                                                <select name="status" class="form-select" required>
                                                    <option value="Diterima"
                                                        <?php echo ($row['status'] == 'Diterima') ? 'selected' : ''; ?>>
                                                        Diterima</option>
                                                    <option value="Ditolak"
                                                        <?php echo ($row['status'] == 'Ditolak') ? 'selected' : ''; ?>>
                                                        Ditolak</option>
                                                </select>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Simpan</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Delete -->
                        <div class="modal fade" id="modal-delete-<?php echo $row['id_penerimaan']; ?>" tabindex="-1"
                            aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Konfirmasi Hapus</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        Apakah Anda yakin ingin menghapus penerimaan barang
                                        <?php echo $row['nama_barang']; ?>?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Batal</button>
                                        <a href="penerimaanBarang.php?delete=<?php echo $row['id_penerimaan']; ?>"
                                            class="btn btn-danger">Hapus</a>
                                    </div>
                                </div>
                            </div>
                            <?php } ?>
                            </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Page navigation" class="mt-4">
                            <ul class="pagination pagination-rounded justify-content-center">
                                <?php if ($page > 1) { ?>
                                <li class="page-item">
                                    <a class="page-link"
                                        href="?page=<?php echo $page - 1; ?>&limit=<?php echo $limit; ?>"
                                        aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <?php } ?>
                                <?php for ($i = 1; $i <= $totalPages; $i++) { ?>
                                <li class="page-item <?php if ($i == $page) echo 'active'; ?>">
                                    <a class="page-link"
                                        href="?page=<?php echo $i; ?>&limit=<?php echo $limit; ?>"><?php echo $i; ?></a>
                                </li>
                                <?php } ?>
                                <?php if ($page < $totalPages) { ?>
                                <li class="page-item">
                                    <a class="page-link"
                                        href="?page=<?php echo $page + 1; ?>&limit=<?php echo $limit; ?>"
                                        aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                                <?php } ?>
                            </ul>
                        </nav>
                    </div>

                    <!-- Modal Tambah Penerimaan -->
                    <div class="modal fade" id="tambahPenerimaanModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Tambah Penerimaan Barang</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form method="POST">
                                        <div class="mb-3">
                                            <label class="form-label">Permintaan Barang</label>
                                            <select name="id_permintaan" class="form-select" required>
                                                <?php
                                                $permintaan_query = "SELECT pb.id_permintaan, pb.nama_barang, d.nama_departemen 
                                                                    FROM permintaan_barang pb 
                                                                    JOIN departemen d ON pb.id_departemen = d.id_departemen 
                                                                    WHERE pb.status = 1";
                                                $permintaan_result = mysqli_query($conn, $permintaan_query);
                                                while ($permintaan = mysqli_fetch_assoc($permintaan_result)) {
                                                    echo "<option value='" . $permintaan['id_permintaan'] . "'>" 
                                                         . $permintaan['nama_barang'] . " - " 
                                                         . $permintaan['nama_departemen'] . "</option>";
                                                }
                                                ?>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Tanggal Terima</label>
                                            <input type="date" name="tanggal_terima" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Jumlah</label>
                                            <input type="number" name="jumlah" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Satuan</label>
                                            <input type="text" name="satuan" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Status</label>
                                            <select name="status" class="form-select" required>
                                                <option value="Diterima">Diterima</option>
                                                <option value="Ditolak">Ditolak</option>
                                            </select>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" name="tambahPenerimaan"
                                                class="btn btn-primary">Tambah</button>
                                            <button type="button" class="btn btn-secondary"
                                                data-bs-dismiss="modal">Batal</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <?php require('../layouts/footer.php'); ?>
            <!-- / Footer -->
            <div class="content-backdrop fade"></div>
        </div>
        <!-- Content wrapper -->
    </div>
    <!-- / Layout page -->

    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
    <!-- Drag Target Area To SlideIn Menu On Small Screens -->
    <div class="drag-target"></div>
</div>
<!-- / Layout wrapper -->

<?php require('../layouts/assetsFooter.php'); ?>

buatkan saya halaman kontrol_barang.php. pada saat menambahkan data saya ingin petugas kontrol adalah nama user yang
sedang login secara otomatis dengan kolom dikunci. kontrol barang berdasarkan cawu, cawu dipilih berdasarkan rentang
bulan ketika memasukan tanggal. masukan jumlah barang yang sama dengan tabel inventaris ketika menambah barang dengan
kondisi baik. jika barang pindah atau rusak maka jumlah barang akan berkurang di tabel barang inventaris ataupun tabel
kontrol barang, dan akan masuk ke dalam tabel barang rusak ataupun barang pindah dengan menambahkan jumlahnya saja
sesuai dengan kode barangnya tanpa menambah data barang lagi. jika barang diedit kembali dengan kondisi baik. maka data
pada tabel barang rusak atau barang pindah akan dikurangi jumlahnya atau dihapus jika jumlahnya telah habis, dan pada
tabel inventaris dan kontrol barang akan bertambah jumlah barangnya sesuai dengan tabel barang rusak dan pindah. jika
semua barang rusak atau pindah, maka jumlah pada tabel inventaris adalah 0 dan jangan tampilkan pada tabel inventaris.
tampilkan kode barang dan nama barang dalam satu kolom pada modal

<?php
require('../server/sessionHandler.php');
require('../server/configDB.php');
require('../layouts/header.php');

// Fungsi untuk menentukan Cawu berdasarkan bulan
function determineCawu($month)
{
    if ($month >= 1 && $month <= 3) {
        return "Cawu 1";
    } elseif ($month >= 4 && $month <= 6) {
        return "Cawu 2";
    } elseif ($month >= 7 && $month <= 9) {
        return "Cawu 3";
    } else {
        return "Cawu 4";
    }
}

// Proses penambahan kontrol barang
if (isset($_POST['tambahKontrol'])) {
    $id_user = $_SESSION['id_user'];
    $id_inventaris = $_POST['id_inventaris'];
    $tanggal = $_POST['tanggal'];
    $status = $_POST['status'];
    $jumlah = isset($_POST['jumlah']) ? $_POST['jumlah'] : 0;
    $keterangan = $_POST['keterangan'];

    mysqli_begin_transaction($conn);

    try {
        // Get inventaris data
        $invQuery = "SELECT jumlah FROM inventaris WHERE id_inventaris = '$id_inventaris' FOR UPDATE";
        $invResult = mysqli_query($conn, $invQuery);
        $invData = mysqli_fetch_assoc($invResult);

        // Set jumlah based on status
        if ($status == 1) { // Baik
            $jumlah = $invData['jumlah']; // Set jumlah to current inventory amount
        } else {
            if ($jumlah > $invData['jumlah']) {
                throw new Exception("Jumlah melebihi stok yang tersedia!");
            }
        }

        // Get cawu
        $month = date('n', strtotime($tanggal));
        $cawu = determineCawu($month);

        // Insert ke kontrol_barang
        $kontrolQuery = "INSERT INTO kontrol_barang (id_user, id_invetaris, cawu, tanggal, status, jumlah, keterangan)
                        VALUES ('$id_user', '$id_inventaris', '$cawu', '$tanggal', '$status', '$jumlah', '$keterangan')";
        mysqli_query($conn, $kontrolQuery);
        $id_kontrol = mysqli_insert_id($conn);

        if ($status == 2) { // Rusak
            // Kurangi stok inventaris
            $updateInv = "UPDATE inventaris SET jumlah = jumlah - $jumlah WHERE id_inventaris = '$id_inventaris'";
            mysqli_query($conn, $updateInv);

            // Catat di kerusakan_barang
            $rusakQuery = "INSERT INTO kerusakan_barang (id_kontrol_barang, cawu, tanggal_kerusakan, jumlah, keterangan)
                          VALUES ('$id_kontrol', '$cawu', '$tanggal', '$jumlah', '$keterangan')";
            mysqli_query($conn, $rusakQuery);

            // Cek jika stok habis untuk arsip
            $checkStok = "SELECT jumlah FROM inventaris WHERE id_inventaris = '$id_inventaris'";
            $stokResult = mysqli_query($conn, $checkStok);
            $stokData = mysqli_fetch_assoc($stokResult);

            if ($stokData['jumlah'] <= 0) {
                // Pindahkan ke arsip
                $arsipQuery = "INSERT INTO arsip_inventaris 
                              SELECT null, i.id_inventaris, i.kode_inventaris, pb.nama_barang,
                                     kb.jumlah, i.satuan, kb.status, CURRENT_DATE(), kb.keterangan
                              FROM inventaris i
                              JOIN penerimaan_barang pb ON i.id_penerimaan = pb.id_penerimaan
                              JOIN kontrol_barang kb ON kb.id_invetaris = i.id_inventaris
                              WHERE i.id_inventaris = '$id_inventaris'";
                mysqli_query($conn, $arsipQuery);

                // Hapus dari inventaris
                mysqli_query($conn, "DELETE FROM inventaris WHERE id_inventaris = '$id_inventaris'");
            }
        } elseif ($status == 3) { // Pindah
            // Kurangi stok inventaris
            $updateInv = "UPDATE inventaris SET jumlah = jumlah - $jumlah WHERE id_inventaris = '$id_inventaris'";
            mysqli_query($conn, $updateInv);

            // Catat di perpindahan_barang
            $pindahQuery = "INSERT INTO perpindahan_barang (id_kontrol_barang, cawu, tanggal_perpindahan, jumlah, keterangan)
                           VALUES ('$id_kontrol', '$cawu', '$tanggal', '$jumlah', '$keterangan')";
            mysqli_query($conn, $pindahQuery);

            // Cek jika stok habis untuk arsip
            $checkStok = "SELECT jumlah FROM inventaris WHERE id_inventaris = '$id_inventaris'";
            $stokResult = mysqli_query($conn, $checkStok);
            $stokData = mysqli_fetch_assoc($stokResult);

            if ($stokData['jumlah'] <= 0) {
                // Pindahkan ke arsip
                $arsipQuery = "INSERT INTO arsip_inventaris 
                              SELECT null, i.id_inventaris, i.kode_inventaris, pb.nama_barang,
                                     kb.jumlah, i.satuan, kb.status, CURRENT_DATE(), kb.keterangan
                              FROM inventaris i
                              JOIN penerimaan_barang pb ON i.id_penerimaan = pb.id_penerimaan
                              JOIN kontrol_barang kb ON kb.id_invetaris = i.id_inventaris
                              WHERE i.id_inventaris = '$id_inventaris'";
                mysqli_query($conn, $arsipQuery);

                // Hapus dari inventaris
                mysqli_query($conn, "DELETE FROM inventaris WHERE id_inventaris = '$id_inventaris'");
            }
        }

        mysqli_commit($conn);
        $_SESSION['success_message'] = "Kontrol barang berhasil ditambahkan!";
    } catch (Exception $e) {
        mysqli_rollback($conn);
        $_SESSION['error_message'] = "Gagal menambahkan kontrol barang: " . $e->getMessage();
    }

    header("Location: kontrol_barang.php");
    exit();
}

// Proses update data kontrol barang
if (isset($_POST['action']) && $_POST['action'] == 'update') {
    $id_kontrol = $_POST['id_kontrol'];
    $id_inventaris = $_POST['id_inventaris'];
    $status_baru = $_POST['status'];
    $jumlah_baru = $_POST['jumlah'];
    $keterangan = $_POST['keterangan'];

    mysqli_begin_transaction($conn);

    try {
        // Ambil data kontrol lama
        $oldDataQuery = "SELECT kb.*, i.jumlah as jumlah_inventaris 
                        FROM kontrol_barang kb
                        JOIN inventaris i ON kb.id_invetaris = i.id_inventaris
                        WHERE kb.id_kontrol_barang = '$id_kontrol'";
        $oldResult = mysqli_query($conn, $oldDataQuery);
        $oldData = mysqli_fetch_assoc($oldResult);
        $status_lama = $oldData['status'];
        $jumlah_lama = $oldData['jumlah'];

        // Jika status berubah dari rusak/pindah ke baik
        if (($status_lama == 2 || $status_lama == 3) && $status_baru == 1) {
            // Get current inventory amount
            $invQuery = "SELECT jumlah FROM inventaris WHERE id_inventaris = '$id_inventaris'";
            $invResult = mysqli_query($conn, $invQuery);
            $invData = mysqli_fetch_assoc($invResult);

            // Kembalikan jumlah ke inventaris
            $updateInv = "UPDATE inventaris SET jumlah = jumlah + $jumlah_lama 
                         WHERE id_inventaris = '$id_inventaris'";
            mysqli_query($conn, $updateInv);

            // Set jumlah baru ke jumlah inventaris terkini
            $jumlah_baru = $invData['jumlah'] + $jumlah_lama;

            // Hapus data dari tabel terkait
            if ($status_lama == 2) {
                mysqli_query($conn, "DELETE FROM kerusakan_barang WHERE id_kontrol_barang = '$id_kontrol'");
            } else {
                mysqli_query($conn, "DELETE FROM perpindahan_barang WHERE id_kontrol_barang = '$id_kontrol'");
            }

            // Restore from arsip if exists
            $checkArsip = "SELECT * FROM arsip_inventaris WHERE id_inventaris = '$id_inventaris'";
            $arsipResult = mysqli_query($conn, $checkArsip);
            if (mysqli_num_rows($arsipResult) > 0) {
                // Delete from arsip since item is restored
                mysqli_query($conn, "DELETE FROM arsip_inventaris WHERE id_inventaris = '$id_inventaris'");
            }
        }
        // Jika status tetap rusak/pindah tapi jumlah berubah
        elseif (($status_lama == 2 || $status_lama == 3) && $status_lama == $status_baru && $jumlah_lama != $jumlah_baru) {
            $selisih = $jumlah_baru - $jumlah_lama;

            // Update jumlah di inventaris
            if ($selisih > 0) {
                // Check if enough stock
                $checkStock = "SELECT jumlah FROM inventaris WHERE id_inventaris = '$id_inventaris'";
                $stockResult = mysqli_query($conn, $checkStock);
                $stockData = mysqli_fetch_assoc($stockResult);

                if ($selisih > $stockData['jumlah']) {
                    throw new Exception("Jumlah melebihi stok yang tersedia!");
                }

                $updateInv = "UPDATE inventaris SET jumlah = jumlah - $selisih 
                             WHERE id_inventaris = '$id_inventaris'";
            } else {
                $updateInv = "UPDATE inventaris SET jumlah = jumlah + " . abs($selisih) . "
                             WHERE id_inventaris = '$id_inventaris'";
            }
            mysqli_query($conn, $updateInv);

            // Update jumlah di tabel terkait
            if ($status_baru == 2) {
                $updateTable = "UPDATE kerusakan_barang SET jumlah = $jumlah_baru 
                              WHERE id_kontrol_barang = '$id_kontrol'";
            } else {
                $updateTable = "UPDATE perpindahan_barang SET jumlah = $jumlah_baru 
                              WHERE id_kontrol_barang = '$id_kontrol'";
            }
            mysqli_query($conn, $updateTable);

            // Check if need to archive
            $checkJumlah = "SELECT jumlah FROM inventaris WHERE id_inventaris = '$id_inventaris'";
            $jumlahResult = mysqli_query($conn, $checkJumlah);
            $jumlahData = mysqli_fetch_assoc($jumlahResult);

            if ($jumlahData['jumlah'] <= 0) {
                $arsipQuery = "INSERT INTO arsip_inventaris 
                              SELECT null, i.id_inventaris, i.kode_inventaris, pb.nama_barang,
                                     kb.jumlah, i.satuan, kb.status, CURRENT_DATE(), kb.keterangan
                              FROM inventaris i
                              JOIN penerimaan_barang pb ON i.id_penerimaan = pb.id_penerimaan
                              JOIN kontrol_barang kb ON kb.id_invetaris = i.id_inventaris
                              WHERE i.id_inventaris = '$id_inventaris'";
                mysqli_query($conn, $arsipQuery);

                // Delete from inventaris
                mysqli_query($conn, "DELETE FROM inventaris WHERE id_inventaris = '$id_inventaris'");
            }
        }

        // Update kontrol_barang
        $updateKontrol = "UPDATE kontrol_barang SET 
                         status = '$status_baru',
                         jumlah = '$jumlah_baru',
                         keterangan = '$keterangan'
                         WHERE id_kontrol_barang = '$id_kontrol'";
        mysqli_query($conn, $updateKontrol);

        mysqli_commit($conn);
        $_SESSION['success_message'] = "Kontrol barang berhasil diupdate!";
    } catch (Exception $e) {
        mysqli_rollback($conn);
        $_SESSION['error_message'] = "Gagal mengupdate kontrol barang: " . $e->getMessage();
    }

    header("Location: kontrol_barang.php");
    exit();
}

// Proses hapus data kontrol barang
if (isset($_GET['delete'])) {
    $id_kontrol = $_GET['delete'];

    mysqli_begin_transaction($conn);

    try {
        // Ambil data kontrol sebelum dihapus
        $dataQuery = "SELECT kb.*, i.id_inventaris 
                     FROM kontrol_barang kb
                     JOIN inventaris i ON kb.id_invetaris = i.id_inventaris
                     WHERE kb.id_kontrol_barang = '$id_kontrol'";
        $dataResult = mysqli_query($conn, $dataQuery);
        $controlData = mysqli_fetch_assoc($dataResult);

        if ($controlData['status'] != 1) { // Jika status rusak atau pindah
            // Kembalikan jumlah ke inventaris
            $updateInv = "UPDATE inventaris 
                         SET jumlah = jumlah + {$controlData['jumlah']}
                         WHERE id_inventaris = '{$controlData['id_inventaris']}'";
            mysqli_query($conn, $updateInv);

            // Hapus data dari tabel terkait
            if ($controlData['status'] == 2) {
                mysqli_query($conn, "DELETE FROM kerusakan_barang WHERE id_kontrol_barang = '$id_kontrol'");
            } else {
                mysqli_query($conn, "DELETE FROM perpindahan_barang WHERE id_kontrol_barang = '$id_kontrol'");
            }

            // Check if item was archived
            $checkArsip = "SELECT * FROM arsip_inventaris WHERE id_inventaris = '{$controlData['id_inventaris']}'";
            $arsipResult = mysqli_query($conn, $checkArsip);
            if (mysqli_num_rows($arsipResult) > 0) {
                // Delete from arsip since item is restored
                mysqli_query($conn, "DELETE FROM arsip_inventaris WHERE id_inventaris = '{$controlData['id_inventaris']}'");
            }
        }
        // Hapus data kontrol
        mysqli_query($conn, "DELETE FROM kontrol_barang WHERE id_kontrol_barang = '$id_kontrol'");

        mysqli_commit($conn);
        $_SESSION['success_message'] = "Kontrol barang berhasil dihapus!";
    } catch (Exception $e) {
        mysqli_rollback($conn);
        $_SESSION['error_message'] = "Gagal menghapus kontrol barang: " . $e->getMessage();
    }

    header("Location: kontrol_barang.php");
    exit();
}

// Function untuk restore barang dari arsip
function restoreFromArsip($conn, $id_arsip)
{
    mysqli_begin_transaction($conn);

    try {
        // Ambil data arsip
        $arsipQuery = "SELECT * FROM arsip_inventaris WHERE id_arsip = '$id_arsip'";
        $arsipResult = mysqli_query($conn, $arsipQuery);
        $arsipData = mysqli_fetch_assoc($arsipResult);

        // Restore ke inventaris
        $restoreQuery = "INSERT INTO inventaris (
                            id_inventaris, kode_inventaris, id_penerimaan,
                            jumlah, satuan, kondisi
                        ) VALUES (
                            '{$arsipData['id_inventaris']}',
                            '{$arsipData['kode_inventaris']}',
                            (SELECT id_penerimaan FROM penerimaan_barang 
                             WHERE nama_barang = '{$arsipData['nama_barang']}' LIMIT 1),
                            '{$arsipData['jumlah']}',
                            '{$arsipData['satuan']}',
                            1
                        )";
        mysqli_query($conn, $restoreQuery);

        if ($arsipData['status'] == 2) {
            // Clear kerusakan_barang records
            $updateKerusakan = "UPDATE kerusakan_barang SET jumlah = 0
                               WHERE id_kontrol_barang IN (
                                   SELECT id_kontrol_barang FROM kontrol_barang 
                                   WHERE id_invetaris = '{$arsipData['id_inventaris']}'
                               )";
            mysqli_query($conn, $updateKerusakan);
        } else if ($arsipData['status'] == 3) {
            // Clear perpindahan_barang records
            $updatePerpindahan = "UPDATE perpindahan_barang SET jumlah = 0
                                 WHERE id_kontrol_barang IN (
                                     SELECT id_kontrol_barang FROM kontrol_barang 
                                     WHERE id_invetaris = '{$arsipData['id_inventaris']}'
                                 )";
            mysqli_query($conn, $updatePerpindahan);
        }

        // Hapus dari arsip
        mysqli_query($conn, "DELETE FROM arsip_inventaris WHERE id_arsip = '$id_arsip'");

        mysqli_commit($conn);
        return true;
    } catch (Exception $e) {
        mysqli_rollback($conn);
        return false;
    }
}

// Pengaturan untuk pagination
$limit = isset($_GET['limit']) ? (int) $_GET['limit'] : 5;
$page = isset($_GET['page']) ? (int) $_GET['page'] : 1;
$offset = ($page - 1) * $limit;

// Penanganan pencarian
$search = isset($_POST['search']) ? $_POST['search'] : '';

// Query untuk menampilkan data kontrol barang dengan join ke tabel terkait
$query = "SELECT kb.*, i.kode_inventaris, i.jumlah as jumlah_inventaris, 
          pb.nama_barang, i.kondisi, u.nama as nama_petugas
          FROM kontrol_barang kb
          JOIN inventaris i ON kb.id_invetaris = i.id_inventaris
          JOIN penerimaan_barang pb ON i.id_penerimaan = pb.id_penerimaan
          JOIN user u ON kb.id_user = u.id_user
          WHERE i.kode_inventaris LIKE '%$search%'
          ORDER BY kb.tanggal DESC, kb.id_kontrol_barang DESC
          LIMIT $limit OFFSET $offset";
$result = mysqli_query($conn, $query);

// Hitung total data untuk keperluan pagination
$totalQuery = "SELECT COUNT(*) as total FROM kontrol_barang kb
               JOIN inventaris i ON kb.id_invetaris = i.id_inventaris
               WHERE i.kode_inventaris LIKE '%$search%'";
$totalResult = mysqli_query($conn, $totalQuery);
$totalRow = mysqli_fetch_assoc($totalResult);
$totalPages = ceil($totalRow['total'] / $limit);

// Select untuk mendapatkan data inventaris
function getInventarisJumlah($conn, $id_inventaris)
{
    $query = "SELECT jumlah FROM inventaris WHERE id_inventaris = '$id_inventaris'";
    $result = mysqli_query($conn, $query);
    $data = mysqli_fetch_assoc($result);
    return $data['jumlah'];
}
?>

<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <?php require('../layouts/sidePanel.php'); ?>

        <div class="layout-page">
            <div class="content-wrapper">
                <div class="container-xxl flex-grow-1 container-p-y">
                    <!-- Header -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="d-flex align-items-center row">
                                    <div class="col-sm-7">
                                        <div class="card-body">
                                            <h4 class="card-title mb-1">
                                                Manajemen Kontrol Barang
                                            </h4>
                                            <nav aria-label="breadcrumb">
                                                <ol class="breadcrumb">
                                                    <li class="breadcrumb-item">
                                                        <a href="dashboard.php">Dashboard</a>
                                                    </li>
                                                    <li class="breadcrumb-item active">Manajemen Kontrol Barang</li>
                                                </ol>
                                            </nav>
                                        </div>
                                    </div>
                                    <div class="col-sm-5 text-center text-sm-left">
                                        <div class="card-body pb-0 px-0 px-md-4">
                                            <button type="button" class="btn btn-primary mb-3 text-nowrap add-new"
                                                data-bs-toggle="modal" data-bs-target="#tambahKontrolModal">
                                                <i class="ti ti-plus"></i>
                                                Tambah Kontrol
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alert Messages -->
                    <?php if (isset($_SESSION['error_message'])): ?>
                    <div class="alert alert-danger alert-dismissible d-flex align-items-center" role="alert">
                        <i class="ti ti-x ti-sm me-2"></i>
                        <div class="text">
                            <?php echo $_SESSION['error_message']; ?>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <?php unset($_SESSION['error_message']); endif; ?>

                    <?php if (isset($_SESSION['success_message'])): ?>
                    <div class="alert alert-success alert-dismissible d-flex align-items-center" role="alert">
                        <i class="ti ti-check ti-sm me-2"></i>
                        <div class="text">
                            <?php echo $_SESSION['success_message']; ?>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <?php unset($_SESSION['success_message']); endif; ?>

                    <!-- Main Content -->
                    <div class="card">
                        <div class="card-header border-bottom">
                            <div class="row">
                                <div class="col-md-6">
                                    <form method="POST" class="d-flex">
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="search"
                                                placeholder="Cari kode inventaris..." value="<?php echo $search; ?>">
                                            <button class="btn btn-outline-primary" type="submit">
                                                <i class="ti ti-search"></i>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-end gap-2">
                                        <div class="d-flex align-items-center">
                                            <label class="text-muted me-2">Show:</label>
                                            <select class="form-select form-select-sm"
                                                onchange="location = this.value;">
                                                <option value="?limit=5" <?php if($limit == 5) echo 'selected';?>>5
                                                </option>
                                                <option value="?limit=10" <?php if($limit == 10) echo 'selected';?>>10
                                                </option>
                                                <option value="?limit=20" <?php if($limit == 20) echo 'selected';?>>20
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="table-responsive text-nowrap">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="text-center">No</th>
                                        <th>Kode Inventaris</th>
                                        <th>Nama Barang</th>
                                        <th>Cawu</th>
                                        <th>Tanggal</th>
                                        <th>Status</th>
                                        <th class="text-end">Jumlah</th>
                                        <th>Keterangan</th>
                                        <th>Petugas</th>
                                        <th class="text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php 
                                    if(mysqli_num_rows($result) > 0):
                                        $no = $offset + 1;
                                        while($row = mysqli_fetch_assoc($result)): 
                                    ?>
                                    <tr>
                                        <td class="text-center"><?php echo $no++; ?></td>
                                        <td><?php echo $row['kode_inventaris']; ?></td>
                                        <td><?php echo $row['nama_barang']; ?></td>
                                        <td><?php echo $row['cawu']; ?></td>
                                        <td><?php echo date('d/m/Y', strtotime($row['tanggal'])); ?></td>
                                        <td>
                                            <?php 
                                            switch($row['status']) {
                                                case 1:
                                                    echo '<span class="badge bg-success">Baik</span>';
                                                    break;
                                                case 2:
                                                    echo '<span class="badge bg-danger">Rusak</span>';
                                                    break;
                                                case 3:
                                                    echo '<span class="badge bg-warning">Pindah</span>';
                                                    break;
                                            }
                                            ?>
                                        </td>
                                        <td class="text-end"><?php echo number_format($row['jumlah']); ?></td>
                                        <td><?php echo $row['keterangan']; ?></td>
                                        <td><?php echo $row['nama_petugas']; ?></td>
                                        <td>
                                            <div class="d-flex justify-content-center gap-1">
                                                <button type="button" class="btn btn-icon btn-sm btn-info"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modal-update-<?php echo $row['id_kontrol_barang']; ?>"
                                                    title="Edit">
                                                    <i class="ti ti-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-icon btn-sm btn-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modal-delete-<?php echo $row['id_kontrol_barang']; ?>"
                                                    title="Hapus">
                                                    <i class="ti ti-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Modal Update -->
                                    <div class="modal fade" id="modal-update-<?php echo $row['id_kontrol_barang']; ?>"
                                        tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-lg" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Edit Kontrol Barang</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <form method="POST">
                                                    <div class="modal-body">
                                                        <input type="hidden" name="action" value="update">
                                                        <input type="hidden" name="id_kontrol"
                                                            value="<?php echo $row['id_kontrol_barang']; ?>">
                                                        <input type="hidden" name="id_inventaris"
                                                            value="<?php echo $row['id_invetaris']; ?>">

                                                        <div class="row g-3">
                                                            <div class="col-12">
                                                                <label class="form-label">Barang</label>
                                                                <input type="text" class="form-control" readonly
                                                                    value="<?php echo $row['kode_inventaris'] . ' - ' . $row['nama_barang']; ?>">
                                                            </div>

                                                            <div class="col-md-6">
                                                                <label class="form-label">Status</label>
                                                                <select name="status" class="form-select" required
                                                                    onchange="toggleInputs(this.value, 'edit-<?php echo $row['id_kontrol_barang']; ?>')">
                                                                    <option value="1"
                                                                        <?php if($row['status'] == 1) echo 'selected';?>>
                                                                        Baik
                                                                    </option>
                                                                    <option value="2"
                                                                        <?php if($row['status'] == 2) echo 'selected';?>>
                                                                        Rusak
                                                                    </option>
                                                                    <option value="3"
                                                                        <?php if($row['status'] == 3) echo 'selected';?>>
                                                                        Pindah
                                                                    </option>
                                                                </select>
                                                            </div>

                                                            <div class="col-md-6">
                                                                <label class="form-label">Jumlah</label>
                                                                <input type="number" name="jumlah" min="1"
                                                                    class="form-control"
                                                                    id="jumlah-edit-<?php echo $row['id_kontrol_barang']; ?>"
                                                                    value="<?php echo $row['jumlah']; ?>" required
                                                                    <?php if($row['status'] == 1) echo 'readonly';?>>
                                                            </div>

                                                            <div class="col-12">
                                                                <label class="form-label">Keterangan</label>
                                                                <textarea name="keterangan" rows="3"
                                                                    class="form-control"
                                                                    id="keterangan-edit-<?php echo $row['id_kontrol_barang']; ?>"
                                                                    required
                                                                    <?php if($row['status'] == 1) echo 'readonly';?>><?php echo $row['keterangan']; ?></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-label-secondary"
                                                            data-bs-dismiss="modal">Batal</button>
                                                        <button type="submit" class="btn btn-primary">Simpan</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Modal Delete -->
                                    <div class="modal fade" id="modal-delete-<?php echo $row['id_kontrol_barang']; ?>"
                                        tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-sm" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Hapus Data</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body text-center">
                                                    <p class="mb-0">Yakin akan menghapus data kontrol untuk barang:</p>
                                                    <h5 class="mb-0"><?php echo $row['kode_inventaris']; ?>?</h5>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-label-secondary"
                                                        data-bs-dismiss="modal">Batal</button>
                                                    <a href="?delete=<?php echo $row['id_kontrol_barang']; ?>"
                                                        class="btn btn-danger">Hapus</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <?php 
                                        endwhile;
                                    else:
                                    ?>
                                    <tr>
                                        <td colspan="10" class="text-center">Tidak ada data</td>
                                    </tr>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="card-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted">
                                    Showing <?php echo $offset + 1; ?> to
                                    <?php echo min($offset + $limit, $totalRow['total']); ?> of
                                    <?php echo $totalRow['total']; ?> entries
                                </div>
                                <ul class="pagination pagination-rounded m-0">
                                    <?php if ($page > 1): ?>
                                    <li class="page-item">
                                        <a class="page-link"
                                            href="?page=<?php echo $page - 1; ?>&limit=<?php echo $limit; ?>"
                                            aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <?php endif; ?>

                                    <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                                    <li class="page-item <?php if($i == $page) echo 'active'; ?>">
                                        <a class="page-link" href="?page=href="
                                            ?page=<?php echo $i; ?>&limit=<?php echo $limit; ?>">
                                            <?php echo $i; ?>
                                        </a>
                                    </li>
                                    <?php endfor; ?>

                                    <?php if ($page < $totalPages): ?>
                                    <li class="page-item">
                                        <a class="page-link"
                                            href="?page=<?php echo $page + 1; ?>&limit=<?php echo $limit; ?>"
                                            aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <?php endif; ?>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Tambah -->
                <div class="modal fade" id="tambahKontrolModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Tambah Kontrol Barang</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <form method="POST">
                                <div class="modal-body">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">Inventaris</label>
                                            <select name="id_inventaris" class="form-select select2" required
                                                onchange="updateJumlah(this.value)">
                                                <option value="">Pilih Barang</option>
                                                <?php
                                                $invQuery = "SELECT i.*, pb.nama_barang 
                                                            FROM inventaris i
                                                            JOIN penerimaan_barang pb ON i.id_penerimaan = pb.id_penerimaan
                                                            WHERE i.jumlah > 0
                                                            ORDER BY i.kode_inventaris ASC";
                                                $invResult = mysqli_query($conn, $invQuery);
                                                while ($inv = mysqli_fetch_assoc($invResult)) {
                                                    echo "<option value='{$inv['id_inventaris']}' data-jumlah='{$inv['jumlah']}'>" 
                                                         . $inv['kode_inventaris'] . " - " 
                                                         . $inv['nama_barang'] . " (Stok: " . $inv['jumlah'] . ")</option>";
                                                }
                                                ?>
                                            </select>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label">Tanggal</label>
                                            <input type="date" name="tanggal" class="form-control"
                                                value="<?php echo date('Y-m-d'); ?>" required>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label">Status</label>
                                            <select name="status" class="form-select" required
                                                onchange="toggleInputs(this.value, 'add')">
                                                <option value="1">Baik</option>
                                                <option value="2">Rusak</option>
                                                <option value="3">Pindah</option>
                                            </select>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label">Jumlah</label>
                                            <input type="number" name="jumlah" id="jumlah-add" class="form-control"
                                                required readonly>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label">Keterangan</label>
                                            <textarea name="keterangan" id="keterangan-add" class="form-control"
                                                rows="3" required readonly>Barang dalam kondisi baik</textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-label-secondary"
                                        data-bs-dismiss="modal">Batal</button>
                                    <button type="submit" name="tambahKontrol" class="btn btn-primary">Tambah</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <?php require('../layouts/footer.php'); ?>
            </div>
        </div>
    </div>
</div>

<script>
// Fungsi untuk toggle input fields berdasarkan status
function toggleInputs(status, prefix) {
    const jumlahField = document.getElementById('jumlah-' + prefix);
    const keteranganField = document.getElementById('keterangan-' + prefix);

    if (status === '1') {
        jumlahField.readOnly = true;
        keteranganField.readOnly = true;
        if (prefix === 'add') {
            const inventarisSelect = document.querySelector('select[name="id_inventaris"]');
            const selectedOption = inventarisSelect.options[inventarisSelect.selectedIndex];
            jumlahField.value = selectedOption ? selectedOption.dataset.jumlah : '';
            keteranganField.value = 'Barang dalam kondisi baik';
        }
    } else {
        jumlahField.readOnly = false;
        keteranganField.readOnly = false;
        if (prefix === 'add') {
            jumlahField.value = '';
            keteranganField.value = '';
        }
    }
}

// Fungsi untuk update jumlah saat inventaris dipilih
function updateJumlah(id_inventaris) {
    const status = document.querySelector('select[name="status"]').value;
    if (status === '1') {
        const selectedOption = document.querySelector(`select[name="id_inventaris"] option[value="${id_inventaris}"]`);
        if (selectedOption) {
            document.getElementById('jumlah-add').value = selectedOption.dataset.jumlah;
        }
    }
}

// Initialize Select2
$(document).ready(function() {
    $('.select2').select2({
        theme: 'bootstrap-5',
        dropdownParent: $('#tambahKontrolModal')
    });
});
</script>

<?php require('../layouts/assetsFooter.php'); ?>